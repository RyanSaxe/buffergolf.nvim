#!/usr/bin/env bash

# Simple test runner with optional coverage reporting

# Clean up old coverage files
rm -f luacov.stats.out luacov.report.out

# Run tests using mini.test via the minit.lua bootstrap
# Coverage is always enabled if luacov is available
nvim -l tests/minit.lua --minitest
EXIT_CODE=$?

# Generate and show coverage report if requested and tests passed
if [[ "$1" == "--coverage" ]] && [ $EXIT_CODE -eq 0 ]; then
  echo ""
  echo "Generating coverage report..."

  # Check if stats file was generated
  if [ -f luacov.stats.out ]; then
    # Run luacov to generate the report from stats
    if command -v luacov &> /dev/null; then
      luacov
    else
      echo "Warning: luacov command not found. Trying with lua..."
      lua -lluacov.runner -e "require('luacov.runner').load_config(); require('luacov.reporter').report()"
    fi
  fi

  echo ""
  echo "Coverage Report:"
  echo "================"

  if [ -f luacov.report.out ]; then
    # Show summary from the report
    tail -20 luacov.report.out
  else
    echo "No coverage report generated."
    if [ ! -f luacov.stats.out ]; then
      echo "Stats file not found. Luacov may not be installed or loaded."
      echo "Install with: luarocks install luacov"
    else
      echo "Stats file exists but report generation failed."
    fi
  fi
fi

exit $EXIT_CODE