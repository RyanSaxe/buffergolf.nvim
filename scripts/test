#!/usr/bin/env bash

# Check for coverage flag
if [[ "$*" == *"--coverage"* ]]; then
  echo "Running tests with coverage..."
  # Clean up old coverage files
  rm -f luacov.stats.out luacov.report.out
fi

# Run tests using mini.test via the minit.lua bootstrap
nvim -l tests/minit.lua --minitest "$@"
EXIT_CODE=$?

# Show coverage report if coverage was enabled and tests passed
if [[ "$*" == *"--coverage"* ]] && [ $EXIT_CODE -eq 0 ]; then
  echo ""
  echo "Coverage Report:"
  echo "================"

  if [ -f luacov.report.out ]; then
    # Show summary from the report
    tail -20 luacov.report.out
  else
    echo "No coverage report generated. You may need to install luacov."
    echo "Install with: luarocks install luacov"
  fi
fi

exit $EXIT_CODE